<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crocodile Clusters ‚Äî Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Arial}
  header{padding:12px 16px;background:#0047b3;color:#fff}
  #controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0}
  #map{height:80vh;margin:12px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.15)}
  .legend{position:fixed;bottom:20px;left:20px;background:#fff;border:1px solid #bbb;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.15);padding:10px;font-size:12px;max-width:220px}
  .legend b{display:block;margin-bottom:6px}
  .chip{display:inline-block;padding:2px 6px;border-radius:10px;border:1px solid #ccc;margin:2px;font-size:11px;cursor:default}
</style>
</head>
<body>
<header>
  <h1 style="margin:0;font-size:18px;">üêä Crocodile Clusters ‚Äî Leaflet</h1>
  <div id="controls">
    <label>Cluster:
      <select id="clusterFilter">
        <option value="">All</option>
      </select>
    </label>
    <label>Habitat:
      <select id="habitatFilter">
        <option value="">All</option>
      </select>
    </label>
    <label>Country/Region:
      <input id="countryFilter" type="text" placeholder="Type to filter‚Ä¶">
    </label>
    <button id="resetBtn">Reset</button>
    <span id="status" style="color:#e3f2ff;">Loading‚Ä¶</span>
  </div>
</header>

<div id="map"></div>
<div class="legend" id="legend">
  <b>Legend ‚Äì Clusters</b>
  <div id="legendItems"></div>
  <p style="margin:8px 0 0;line-height:1.3;">
    Colors correspond to <b>cluster groups</b> based on species, habitat & region.<br>
    Click a marker for details.
  </p>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
const statusEl = document.getElementById('status');
const clusterSel = document.getElementById('clusterFilter');
const habitatSel = document.getElementById('habitatFilter');
const countryInput = document.getElementById('countryFilter');
const resetBtn = document.getElementById('resetBtn');

const map = L.map('map', {center:[10,0], zoom:2, minZoom:2, maxZoom:8});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

const colors = [
  '#e6194b','#3cb44b','#ffe119','#4363d8','#f58231',
  '#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe',
  '#008080','#e6beff','#9a6324','#fffac8','#800000',
  '#aaffc3','#808000','#ffd8b1','#000075','#808080'
];

let rawFeatures = [];
let markerLayer = L.markerClusterGroup();
map.addLayer(markerLayer);

function clusterColor(clusterId){
  const idx = (parseInt(clusterId,10)-1) % colors.length;
  return colors[idx];
}

function makePopup(props){
  return `
    <b>${props.common_name || ''}</b> <i>(${props.scientific_name || ''})</i><br>
    <b>Cluster:</b> ${props.cluster}<br>
    <b>Conservation:</b> ${props.conservation_status || ''}<br>
    <b>Habitat:</b> ${props.habitat_type || ''}<br>
    <b>Length:</b> ${props.observed_length_m || '‚Äì'} m<br>
    <b>Weight:</b> ${props.observed_weight_kg || '‚Äì'} kg<br>
    <b>Country/Region:</b> ${props.country_region || ''}
  `;
}

function fitBoundsIfAny(bounds){
  if(bounds.length){
    map.fitBounds(bounds, {padding:[40,40]});
  }
}

function uniqueSorted(arr){
  return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>{
    if(!isNaN(+a) && !isNaN(+b)) return (+a)-(+b);
    return (''+a).localeCompare(''+b);
  });
}

function fillFilters(features){
  const clusters = uniqueSorted(features.map(f=>f.properties.cluster));
  const habitats = uniqueSorted(features.map(f=>f.properties.habitat_type));

  clusterSel.innerHTML = '<option value="">All</option>' + clusters.map(c=>`<option value="${c}">${c}</option>`).join('');
  habitatSel.innerHTML = '<option value="">All</option>' + habitats.map(h=>`<option value="${h}">${h}</option>`).join('');
}

function buildLegend(features){
  const clusters = uniqueSorted(features.map(f=>f.properties.cluster));
  const legendItems = document.getElementById('legendItems');
  legendItems.innerHTML = clusters.map(c=>{
    const color = clusterColor(c);
    return `<span class="chip" style="border-color:${color};">${c}</span>`;
  }).join(' ');
}

function passesFilter(props){
  const cVal = clusterSel.value;
  const hVal = habitatSel.value.trim().toLowerCase();
  const countryVal = countryInput.value.trim().toLowerCase();

  if(cVal && String
